<%= form_with(model: lead, local: true, class: "space-y-6") do |form| %>
  <!-- Error Messages -->
  <% if lead.errors.any? %>
    <div class="rounded-lg bg-red-50 p-4 border border-red-200">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= t('leads.form.errors_count', count: lead.errors.count) %>
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% lead.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Main Form Card -->
  <div class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
    <!-- Client Information Section -->
    <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
      <h3 class="text-lg font-medium text-gray-900"><%= t('leads.form.client_information') %></h3>
      <p class="mt-1 text-sm text-gray-600"><%= t('leads.form.client_info_subtitle') %></p>
    </div>

    <div class="px-6 py-6 space-y-6">
      <!-- Client Selection Toggle -->
      <div class="flex items-center space-x-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <label class="inline-flex items-center cursor-pointer">
          <input type="radio" name="client_option" value="existing" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" <%= 'checked' if lead.persisted? || params[:client_id].present? %>>
          <span class="ml-3 text-sm font-medium text-gray-700"><%= t('leads.form.select_existing_client') %></span>
        </label>
        <label class="inline-flex items-center cursor-pointer">
          <input type="radio" name="client_option" value="new" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" <%= 'checked' unless lead.persisted? || params[:client_id].present? %>>
          <span class="ml-3 text-sm font-medium text-gray-700"><%= t('leads.form.create_new_client') %></span>
        </label>
      </div>

      <!-- Existing Client Selection -->
      <div id="existing-client-section" class="<%= 'hidden' unless lead.persisted? || params[:client_id].present? %>">
        <%= form.label :client_id, t('leads.form.select_client'), class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.select :client_id,
            options_from_collection_for_select(Client.order(:name), :id, :name, lead.client_id || params[:client_id]),
            { include_blank: t('leads.form.choose_client') },
            class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
        <p class="mt-2 text-xs text-gray-500"><%= t('leads.form.select_from_existing') %></p>
      </div>

      <!-- New Client Fields -->
      <div id="new-client-section" class="<%= 'hidden' if lead.persisted? || params[:client_id].present? %>">
        <%= form.fields_for :client, (lead.persisted? ? Client.new : (lead.client || Client.new)) do |client_form| %>
          <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border border-gray-200 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- Name -->
              <div>
                <%= client_form.label :name, t('leads.form.client_name'), class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= client_form.text_field :name,
                    class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
                    placeholder: t('leads.form.full_name') %>
              </div>

              <!-- Phone -->
              <div>
                <%= client_form.label :phone, t('clients.attributes.phone'), class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= client_form.telephone_field :phone,
                    class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
                    placeholder: "+1234567890" %>
                <p class="mt-1 text-xs text-gray-500"><%= t('leads.form.phone_hint') %></p>
              </div>

              <!-- Email -->
              <div>
                <%= client_form.label :email, t('leads.form.email_optional'), class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= client_form.email_field :email,
                    class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
                    placeholder: "email@example.com" %>
              </div>

              <!-- Preferred Language -->
              <div>
                <%= client_form.label :preferred_language, t('clients.attributes.preferred_language'), class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= client_form.select :preferred_language,
                    [[t('clients.languages.en'), 'en'], [t('clients.languages.ru'), 'ru']],
                    { include_blank: t('leads.form.select_language') },
                    class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
                <p class="mt-1 text-xs text-gray-500"><%= t('leads.form.language_hint') %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Lead Details Section -->
    <div class="px-6 py-5 border-t border-b border-gray-200 bg-gray-50">
      <h3 class="text-base font-medium text-gray-900"><%= t('leads.form.lead_details') %></h3>
      <p class="mt-1 text-sm text-gray-600"><%= t('leads.form.lead_details_subtitle') %></p>
    </div>

    <div class="px-6 py-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Status -->
        <div>
          <%= form.label :status, t('leads.attributes.status'), class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :status,
              Lead.statuses.keys.map { |s| [t("leads.statuses.#{s}"), s] },
              {},
              class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
          <p class="mt-1 text-xs text-gray-500"><%= t('leads.form.status_hint') %></p>
        </div>

        <!-- Assigned Agent -->
        <div>
          <%= form.label :assigned_agent_id, t('leads.attributes.assigned_agent'), class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :assigned_agent_id,
              [[t('leads.form.unassigned'), nil]] + User.agents.order(:name).map { |a| [a.name, a.id] },
              {},
              class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
          <p class="mt-1 text-xs text-gray-500"><%= t('leads.form.agent_hint') %></p>
        </div>

        <!-- Tour Interest -->
        <div class="sm:col-span-2">
          <%= form.label :tour_interest_id, t('leads.attributes.tour_interest'), class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :tour_interest_id,
              [[t('leads.form.none'), nil]] + (@tours || Tour.active.order(:name)).map { |t| [t.name, t.id] },
              {},
              class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
          <p class="mt-1 text-xs text-gray-500"><%= t('leads.form.tour_interest_hint') %></p>
        </div>
      </div>
    </div>

    <!-- Campaign Tracking Section (Collapsible) -->
    <div class="px-6 py-5 border-t border-gray-200">
      <details class="group">
        <summary class="flex items-center cursor-pointer">
          <h3 class="text-base font-medium text-gray-900"><%= t('leads.form.campaign_tracking') %></h3>
          <span class="ml-2 text-xs text-gray-500"><%= t('leads.form.optional') %></span>
          <svg class="ml-auto h-5 w-5 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </summary>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <%= form.label :campaign_source, t('leads.attributes.campaign_source'), class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.select :campaign_source,
                [[t('leads.form.none'), nil]] + Lead.campaign_sources.keys.map { |s| [t("leads.campaign_sources.#{s}"), s] },
                {},
                class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
          </div>
          <div>
            <%= form.label :campaign_id, t('leads.attributes.campaign_id'), class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :campaign_id,
                class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
                placeholder: "e.g., DSC3_DQANZB" %>
          </div>
          <div class="sm:col-span-2">
            <%= form.label :campaign_url, t('leads.attributes.campaign_url'), class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.url_field :campaign_url,
                class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
                placeholder: "https://www.instagram.com/p/..." %>
          </div>
        </div>
      </details>
    </div>

    <!-- Form Actions -->
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-end space-x-3">
      <%= link_to t('common.cancel'), lead.persisted? ? lead_path(lead) : leads_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors" %>
      <%= form.submit (lead.persisted? ? t('leads.form.update_lead') : t('leads.form.create_lead')), class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors" %>
    </div>
  </div>
<% end %>

<!-- Client Selection Toggle Script -->
<script>
  // Use turbo:load for Rails with Hotwire Turbo
  document.addEventListener('turbo:load', function() {
    const existingRadio = document.querySelector('input[name="client_option"][value="existing"]');
    const newRadio = document.querySelector('input[name="client_option"][value="new"]');
    const existingSection = document.getElementById('existing-client-section');
    const newSection = document.getElementById('new-client-section');

    // Guard clause: ensure elements exist
    if (!existingRadio || !newRadio || !existingSection || !newSection) return;

    function toggleSections() {
      if (existingRadio.checked) {
        existingSection.classList.remove('hidden');
        newSection.classList.add('hidden');
        // Disable new client fields so they won't be submitted
        newSection.querySelectorAll('input, select').forEach(field => {
          if (field.type !== 'hidden') {
            field.disabled = true;
            field.value = '';
          }
        });
        // Enable client selection
        const clientSelect = existingSection.querySelector('select');
        if (clientSelect) clientSelect.disabled = false;
      } else {
        existingSection.classList.add('hidden');
        newSection.classList.remove('hidden');
        // Enable new client fields
        newSection.querySelectorAll('input, select').forEach(field => {
          if (field.type !== 'hidden') {
            field.disabled = false;
          }
        });
        // Disable and clear client selection
        const clientSelect = existingSection.querySelector('select');
        if (clientSelect) {
          clientSelect.disabled = true;
          clientSelect.value = '';
        }
      }
    }

    existingRadio.addEventListener('change', toggleSections);
    newRadio.addEventListener('change', toggleSections);

    // Initialize on page load
    toggleSections();
  });

  // Also support standard DOMContentLoaded for non-Turbo navigation
  document.addEventListener('DOMContentLoaded', function() {
    const existingRadio = document.querySelector('input[name="client_option"][value="existing"]');
    const newRadio = document.querySelector('input[name="client_option"][value="new"]');
    const existingSection = document.getElementById('existing-client-section');
    const newSection = document.getElementById('new-client-section');

    // Guard clause: ensure elements exist
    if (!existingRadio || !newRadio || !existingSection || !newSection) return;

    function toggleSections() {
      if (existingRadio.checked) {
        existingSection.classList.remove('hidden');
        newSection.classList.add('hidden');
        // Disable new client fields so they won't be submitted
        newSection.querySelectorAll('input, select').forEach(field => {
          if (field.type !== 'hidden') {
            field.disabled = true;
            field.value = '';
          }
        });
        // Enable client selection
        const clientSelect = existingSection.querySelector('select');
        if (clientSelect) clientSelect.disabled = false;
      } else {
        existingSection.classList.add('hidden');
        newSection.classList.remove('hidden');
        // Enable new client fields
        newSection.querySelectorAll('input, select').forEach(field => {
          if (field.type !== 'hidden') {
            field.disabled = false;
          }
        });
        // Disable and clear client selection
        const clientSelect = existingSection.querySelector('select');
        if (clientSelect) {
          clientSelect.disabled = true;
          clientSelect.value = '';
        }
      }
    }

    existingRadio.addEventListener('change', toggleSections);
    newRadio.addEventListener('change', toggleSections);

    // Initialize on page load
    toggleSections();
  });
</script>
