<%= form_with(model: booking, class: "space-y-6") do |f| %>
  <!-- Error Messages -->
  <% if booking.errors.any? %>
    <div class="rounded-lg bg-red-50 p-4 border border-red-200">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= t('bookings.form.errors', count: booking.errors.count) %>
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% booking.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="bg-white shadow-sm rounded-lg">
    <div class="px-6 py-5 space-y-6">
      <!-- Client Selection -->
      <div>
        <%= f.label :client_id, t('bookings.attributes.client'), class: "block text-sm font-medium text-gray-700 mb-1" %>
        <% if booking.client.present? && booking.persisted? %>
          <!-- Show readonly client info when editing -->
          <div class="flex items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
              <span class="text-indigo-700 font-semibold text-sm">
                <%= booking.client.name.split(' ').map(&:first).join.upcase[0..1] %>
              </span>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-900"><%= booking.client.name %></p>
              <p class="text-xs text-gray-500"><%= booking.client.phone %></p>
            </div>
            <%= link_to t('bookings.form.view_client'), booking.client, class: "ml-auto text-xs text-indigo-600 hover:text-indigo-700", target: "_blank" %>
          </div>
          <%= f.hidden_field :client_id %>
        <% elsif defined?(@client) && @client.present? %>
          <!-- Pre-selected client from context -->
          <div class="flex items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
              <span class="text-indigo-700 font-semibold text-sm">
                <%= @client.name.split(' ').map(&:first).join.upcase[0..1] %>
              </span>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-900"><%= @client.name %></p>
              <p class="text-xs text-gray-500"><%= @client.phone %></p>
            </div>
          </div>
          <%= f.hidden_field :client_id, value: @client.id %>
        <% else %>
          <!-- Client selection dropdown -->
          <%= f.collection_select :client_id,
            Client.order(:name),
            :id,
            ->(c) { "#{c.name} (#{c.phone})" },
            { prompt: t('bookings.form.select_client_prompt') },
            class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
        <% end %>
      </div>

      <!-- Tour Departure Selection -->
      <div>
        <%= f.label :tour_departure_id, t('bookings.attributes.tour_departure'), class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.collection_select :tour_departure_id,
          @available_departures || TourDeparture.upcoming,
          :id,
          ->(td) { "#{td.tour.name} - #{td.departure_date.strftime('%b %d, %Y')} (#{td.available_spots} #{t('bookings.form.spots_left')}) - #{number_to_currency(td.price, unit: td.currency, precision: 0)}" },
          { prompt: t('bookings.form.select_tour_departure_prompt') },
          {
            class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
            data: { controller: "tour-selector" }
          } %>
        <p class="mt-1 text-xs text-gray-500">
          <%= t('bookings.form.select_tour_help') %>
        </p>
      </div>

      <!-- Number of Participants -->
      <div>
        <%= f.label :num_participants, t('bookings.form.participants_label'), class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :num_participants,
          min: 1,
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
          placeholder: t('bookings.form.participants_placeholder') %>
        <p class="mt-1 text-xs text-gray-500">
          <%= t('bookings.form.participants_help') %>
        </p>
      </div>

      <!-- Total Amount and Currency (in one row) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <%= f.label :total_amount, t('bookings.attributes.total_amount'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.number_field :total_amount,
            step: 0.01,
            min: 0,
            class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",
            placeholder: t('bookings.form.total_amount_placeholder') %>
          <p class="mt-1 text-xs text-gray-500">
            <%= t('bookings.form.total_amount_help') %>
          </p>
        </div>

        <div>
          <%= f.label :currency, t('bookings.attributes.currency'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :currency,
            options_for_select([
              [t('bookings.form.currencies.usd'), 'USD'],
              [t('bookings.form.currencies.kzt'), 'KZT'],
              [t('bookings.form.currencies.eur'), 'EUR'],
              [t('bookings.form.currencies.rub'), 'RUB']
            ], booking.currency || 'USD'),
            {},
            class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
        </div>
      </div>

      <!-- Status -->
      <div>
        <%= f.label :status, t('bookings.attributes.status'), class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :status,
          options_for_select([
            [t('bookings.statuses.confirmed'), 'confirmed'],
            [t('bookings.statuses.paid'), 'paid'],
            [t('bookings.statuses.completed'), 'completed'],
            [t('bookings.statuses.cancelled'), 'cancelled']
          ], booking.status || 'confirmed'),
          {},
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
        <p class="mt-1 text-xs text-gray-500">
          <%= t('bookings.form.status_help') %>
        </p>
      </div>

      <!-- Lead Association (if applicable) -->
      <% if defined?(@lead) && @lead.present? %>
        <%= f.hidden_field :lead_id, value: @lead.id %>
        <div class="rounded-lg bg-blue-50 p-4 border border-blue-200">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="ml-3 text-sm text-blue-700">
              <p><%= t('bookings.form.associated_with_lead') %> <%= link_to "Lead ##{@lead.id}", @lead, class: "font-medium underline", target: "_blank" %></p>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Form Actions -->
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-end space-x-3">
      <%= link_to t('common.cancel'), bookings_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
      <%= f.submit booking.persisted? ? t('bookings.form.update_booking') : t('bookings.form.create_booking'),
        class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    </div>
  </div>
<% end %>

<script>
  // Auto-calculate total amount when tour departure or num_participants changes
  document.addEventListener('DOMContentLoaded', function() {
    const departureSelect = document.querySelector('select[name="booking[tour_departure_id]"]');
    const participantsInput = document.querySelector('input[name="booking[num_participants]"]');
    const totalAmountInput = document.querySelector('input[name="booking[total_amount]"]');
    const currencySelect = document.querySelector('select[name="booking[currency]"]');

    function updateTotalAmount() {
      if (!departureSelect || !participantsInput || !totalAmountInput) return;

      const selectedOption = departureSelect.options[departureSelect.selectedIndex];
      if (!selectedOption || !selectedOption.text) return;

      // Extract price and currency from option text
      const priceMatch = selectedOption.text.match(/(\$|₸|€|₽)([\d,]+)/);
      const currencyMatch = selectedOption.text.match(/\((USD|KZT|EUR|RUB)\)/);

      if (priceMatch && participantsInput.value) {
        const pricePerPerson = parseFloat(priceMatch[2].replace(/,/g, ''));
        const numParticipants = parseInt(participantsInput.value);

        if (!isNaN(pricePerPerson) && !isNaN(numParticipants)) {
          totalAmountInput.value = (pricePerPerson * numParticipants).toFixed(2);
        }
      }

      // Update currency if found
      if (currencyMatch && currencyMatch[1]) {
        currencySelect.value = currencyMatch[1];
      }
    }

    if (departureSelect) departureSelect.addEventListener('change', updateTotalAmount);
    if (participantsInput) participantsInput.addEventListener('input', updateTotalAmount);
  });
</script>
